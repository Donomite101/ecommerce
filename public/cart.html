<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart - ZeroLayer</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    input[type='number']::-webkit-inner-spin-button,
    input[type='number']::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">
  <nav class="bg-white shadow sticky top-0 z-50 p-4">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <a href="/" class="text-xl font-bold text-indigo-600">ZeroLayer</a>
      <div class="space-x-6">
        <a href="/" class="text-gray-700 hover:text-indigo-600">Home</a>
        <a href="/cart.html" class="text-indigo-600 font-semibold">Cart</a>
        <a href="/orders.html" class="text-gray-700 hover:text-indigo-600">Orders</a>
        <a id="login-link" href="/login.html" class="text-gray-700 hover:text-indigo-600">Login</a>
        <button id="logout-button" onclick="logout()" class="text-red-500 hidden">Logout</button>
      </div>
    </div>
  </nav>

  <div class="max-w-6xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-semibold text-center text-gray-800 mb-6">ðŸ›’ Your Shopping Cart</h1>
    <div id="error-message" class="hidden bg-red-100 text-red-700 p-4 rounded mb-4"></div>

    <div id="loading-spinner" class="flex justify-center py-10">
      <div class="animate-spin h-8 w-8 border-4 border-blue-400 border-t-transparent rounded-full"></div>
    </div>

    <div id="cart-container" class="hidden bg-white shadow-md rounded-lg p-6">
      <table class="w-full text-left mb-6">
        <thead>
          <tr class="border-b text-gray-600">
            <th class="py-2 font-medium">Product</th>
            <th class="py-2 font-medium">Price</th>
            <th class="py-2 font-medium">Qty</th>
            <th class="py-2 font-medium">Total</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="cart-items"></tbody>
      </table>

      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <div>
          <span class="text-lg font-semibold">Subtotal:</span>
          <span id="subtotal" class="text-2xl font-bold text-indigo-600 ml-2">â‚¹0.00</span>
        </div>
        <button id="checkout-btn" onclick="proceedToCheckout()" class="bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition disabled:opacity-50 disabled:cursor-not-allowed">Proceed to Checkout</button>
      </div>
    </div>
  </div>

  <script src="/js/logout.js"></script>
  <script>
    let cartItems = [];

    function updateNav() {
      const token = localStorage.getItem('token');
      document.getElementById('login-link').style.display = token ? 'none' : 'inline';
      document.getElementById('logout-button').style.display = token ? 'inline' : 'none';
    }

    async function fetchCart() {
      const token = localStorage.getItem('token');
      if (!token) return (window.location.href = '/login.html');

      const loading = document.getElementById('loading-spinner');
      const errorBox = document.getElementById('error-message');
      const cartContainer = document.getElementById('cart-container');
      const tbody = document.getElementById('cart-items');
      const subtotalElem = document.getElementById('subtotal');
      const checkoutBtn = document.getElementById('checkout-btn');

      loading.classList.remove('hidden');
      cartContainer.classList.add('hidden');
      errorBox.classList.add('hidden');
      tbody.innerHTML = '';
      subtotalElem.textContent = 'â‚¹0.00';

      try {
        const res = await fetch('/api/cart', { headers: { Authorization: `Bearer ${token}` } });
        if (res.status === 401) {
          alert('Session expired. Please login again.');
          localStorage.removeItem('token');
          window.location.href = '/login.html';
          return;
        }
        if (!res.ok) throw new Error(`Failed to fetch cart: HTTP ${res.status}`);

        const data = await res.json();
        cartItems = data.items || [];

        if (cartItems.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center py-6 text-gray-500">Your cart is empty.</td></tr>';
          checkoutBtn.disabled = true;
        } else {
          let subtotal = 0;
          cartItems.forEach(item => {
            const price = item.product.price;
            const quantity = parseInt(item.quantity);
            const total = price * quantity;
            subtotal += total;

            tbody.innerHTML += `
              <tr class="border-b">
                <td class="py-4 flex items-center">
                  <img src="${item.product.image}" alt="${item.product.name}" class="w-16 h-16 object-cover rounded mr-4">
                  <span class="text-gray-700">${item.product.name}</span>
                </td>
                <td class="py-4">â‚¹${price.toFixed(2)}</td>
                <td class="py-4">
                  <input type="number" min="1" value="${quantity}" class="w-16 text-center border rounded px-2 py-1" onchange="updateQuantity('${item.product._id}', this.value)">
                </td>
                <td class="py-4">â‚¹${total.toFixed(2)}</td>
                <td class="py-4 text-right">
                  <button onclick="removeFromCart('${item.product._id}');" class="text-red-500 hover:underline">Remove</button>
                </td>
              </tr>
            `;
          });
          subtotalElem.textContent = `â‚¹${subtotal.toFixed(2)}`;
          checkoutBtn.disabled = false;
        }

        cartContainer.classList.remove('hidden');
      } catch (err) {
        errorBox.textContent = err.message;
        errorBox.classList.remove('hidden');
      } finally {
        loading.classList.add('hidden');
      }
    }

    async function updateQuantity(productId, quantity) {
      const qty = parseInt(quantity);
      if (isNaN(qty) || qty < 1) {
        alert('Invalid quantity');
        fetchCart();
        return;
      }

      const token = localStorage.getItem('token');
      try {
        const res = await fetch('/api/cart/add', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ productId, quantity: qty })
        });
        if (!res.ok) throw new Error(`Failed to update quantity.`);
        await fetchCart();
      } catch (err) {
        alert('Error updating cart.');
        fetchCart();
      }
    }

    async function removeFromCart(productId) {
      const token = localStorage.getItem('token');
      try {
        await fetch('/api/cart/remove', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${token}` },
          body: JSON.stringify({ productId })
        });
        await fetchCart();
      } catch (err) {
        alert('Failed to remove item.');
      }
    }

    function proceedToCheckout() {
      if (cartItems.length === 0) {
        alert('Your cart is empty.');
        return;
      }
      window.location.href = '/checkout.html';
    }

    updateNav();
    fetchCart();
  </script>
</body>
</html>
